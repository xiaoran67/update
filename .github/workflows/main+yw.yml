name: 'main â˜ output/full.txt âœ” + æ‹†åˆ†å¤®è§†/å«è§†'

on:
  #schedule:
    #- cron: '00 21 * * *'  # è§¦å‘æ—¶é—´ï¼ˆUTCæ—¶é—´ï¼Œå¯è°ƒæ•´ï¼‰
    #- cron: '00 09 * * *'  # è§¦å‘æ—¶é—´ï¼ˆUTCæ—¶é—´ï¼Œå¯è°ƒæ•´ï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'  # æ‰‹åŠ¨è§¦å‘é»˜è®¤ç¯å¢ƒ

env:
  PYTHON_VERSION: '3.10'        # Pythonç‰ˆæœ¬
  RETAIN_DAYS: 7                # å½’æ¡£ä¿ç•™å¤©æ•°
  HISTORY_DIR: 'history'        # å½’æ¡£ç›®å½•
  FILES_TO_ARCHIVE: >-          # éœ€å½’æ¡£çš„æ–‡ä»¶ï¼ˆåŸæœ‰ï¼‰
    output/full.txt
    output/simple.txt
    output/others.txt
    output/sports.html
    output/custom.txt
  # æ–°å¢å¤–éƒ¨IPTVå¤„ç†é…ç½®
  IPTV_SOURCE_URL: "https://raw.githubusercontent.com/kakaxi-1/IPTV/refs/heads/main/ipv4.1.txt"  # æºæ–‡ä»¶URL
  TARGET_DIR: "æ‰‹å·¥åŒº"          # ç›®æ ‡ç›®å½•
  CCTV_FILE: "${{ env.TARGET_DIR }}/â™ªä¼˜è´¨å¤®è§†.txt"    # å¤®è§†è¾“å‡ºæ–‡ä»¶
  SATELLITE_FILE: "${{ env.TARGET_DIR }}/â™ªä¼˜è´¨å«è§†.txt"  # å«è§†è¾“å‡ºæ–‡ä»¶

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # å…è®¸å†™å…¥ä»“åº“
      pull-requests: write     # å…è®¸æ“ä½œPR

    steps:
      ### 1. æ‹‰å–ä»“åº“ä»£ç  ###
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main  # æ‹‰å–mainåˆ†æ”¯

      ### 2. å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç  ###
      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main  # ç¡®ä¿ä»£ç ä¸€è‡´

      ### 3. å®‰è£…Pythonç¯å¢ƒ ###
      - name: å®‰è£…Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      ### 4. ç¼“å­˜ä¾èµ–åŒ… ###
      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip 
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      ### 5. å®‰è£…é¡¹ç›®ä¾èµ– ###
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      ### 6. è¿è¡Œä¸»è„šæœ¬ç”Ÿæˆæ–‡ä»¶ï¼ˆåŸæœ‰é€»è¾‘ï¼‰###
      - name: åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git reset --hard HEAD 
          git pull origin main --rebase || { 
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨è¦†ç›–";
            git rebase --abort;
            git pull origin main --force;
          }
          python main.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•"; 
            python main.py || { 
              echo "ç”Ÿæˆå¤±è´¥ï¼Œç»ˆæ­¢"; 
              exit 1; 
            } 
          }

      ### 7. æ ¡éªŒåŸæœ‰ç”Ÿæˆæ–‡ä»¶ï¼ˆåŸæœ‰é€»è¾‘ï¼‰###
      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          critical_files=("output/full.txt" "output/custom.txt")
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file æ— æ•ˆï¼Œç»ˆæ­¢";
              exit 1;
            fi
          done
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/custom.txt"; then
            echo "é”™è¯¯ï¼šç¼ºå¤±å…³é”®åˆ†ç±»ï¼Œç»ˆæ­¢";
            exit 1;
          fi

      ### 8. æ–°å¢ï¼šä¸‹è½½å¹¶å¤„ç†å¤–éƒ¨IPTVæ–‡ä»¶ ###
      - name: ä¸‹è½½å¹¶æ‹†åˆ†å¤®è§†/å«è§†é¢‘é“
        run: |
          # ä¸‹è½½æºæ–‡ä»¶
          curl -fSL "${{ env.IPTV_SOURCE_URL }}" -o temp_ipv4.txt
          if [ ! -f temp_ipv4.txt ]; then
            echo "é”™è¯¯ï¼šå¤–éƒ¨æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          # æ¸…ç†åˆ†ç»„è¡Œï¼ˆåˆ é™¤æ›´æ–°æ—¶é—´ã€#genre#ï¼‰
          sed -e '/æ›´æ–°æ—¶é—´/d' -e '/#genre#/d' temp_ipv4.txt > temp_filtered.txt
          if [ ! -s temp_filtered.txt ]; then
            echo "é”™è¯¯ï¼šæ¸…ç†åæ— æœ‰æ•ˆå†…å®¹ï¼"
            exit 1
          fi
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "${{ env.TARGET_DIR }}"
          # æå–å¤®è§†ï¼ˆè¡Œé¦–CCTVï¼‰
          grep "^CCTV" temp_filtered.txt > "${{ env.CCTV_FILE }}"
          if [ ! -s "${{ env.CCTV_FILE }}" ]; then
            echo "é”™è¯¯ï¼šå¤®è§†æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
          fi
          # æå–å«è§†ï¼ˆå«â€œå«è§†â€å…³é”®å­—ï¼‰
          grep "å«è§†" temp_filtered.txt > "${{ env.SATELLITE_FILE }}"
          if [ ! -s "${{ env.SATELLITE_FILE }}" ]; then
            echo "é”™è¯¯ï¼šå«è§†æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
          fi

      ### 9. æ ¡éªŒæ–°ç”Ÿæˆçš„å¤®è§†/å«è§†é¢‘é“æ–‡ä»¶ ###
      - name: æ ¡éªŒæ‰‹å·¥åŒºæ–‡ä»¶
        run: |
          if [ ! -s "${{ env.CCTV_FILE }}" ]; then
            echo "é”™è¯¯ï¼š${{ env.CCTV_FILE }} æ— æ•ˆï¼"
            exit 1
          fi
          if [ ! -s "${{ env.SATELLITE_FILE }}" ]; then
            echo "é”™è¯¯ï¼š${{ env.SATELLITE_FILE }} æ— æ•ˆï¼"
            exit 1
          fi

      ### 10. æ¸…ç†å†å²å½’æ¡£ï¼ˆåŸæœ‰é€»è¾‘ï¼‰###
      - name: æ¸…ç†å†å²å½’æ¡£
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}
          find ${{ env.HISTORY_DIR }} -name "*.zip" -type f -mtime +${{ env.RETAIN_DAYS }} -delete

      ### 11. ç”Ÿæˆä»Šæ—¥å½’æ¡£ï¼ˆåŸæœ‰é€»è¾‘ï¼Œè‡ªåŠ¨åŒ…å«æ–°æ–‡ä»¶ï¼‰###
      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }} "${{ env.TARGET_DIR }}/"; then
            echo "æ–‡ä»¶æœªå˜ï¼Œä¸ç”Ÿæˆå½’æ¡£";
          else
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_archive.zip"
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }} "${{ env.TARGET_DIR }}/"*
            git add "${zip_filename}"
            echo "æ–°å½’æ¡£ï¼š${zip_filename}"
          fi

      ### 12. æäº¤å¹¶æ¨é€æ‰€æœ‰æ›´æ”¹ï¼ˆå«åŸæœ‰æ–‡ä»¶+æ–°æ–‡ä»¶ï¼‰###
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ï¼ˆåŸæœ‰+æ‰‹å·¥åŒº+å½’æ¡£ï¼‰
          git add output/full.txt output/full.m3u output/simple.txt output/simple.m3u \
                  output/others.txt output/sports.html output/custom.txt output/custom.m3u \
                  ${{ env.HISTORY_DIR }}/ "${{ env.TARGET_DIR }}/"
          # æäº¤ï¼ˆæ— å˜æ›´æ—¶å¿½ç•¥ï¼‰
          git commit -m ":dragon: $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— å˜æ›´éœ€æäº¤"
          # å¤„ç†å†²çªå¹¶æ¨é€
          git pull origin main --rebase --autostash --allow-unrelated-histories || git pull origin main --force
          git push origin main --force-with-lease || git push origin main --force

      ### 13. ä¿å­˜æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ï¼ˆå«æ–°æ–‡ä»¶ï¼‰###
      - name: ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: generated-files 
          path: |
            output/full.txt
            output/full.m3u
            output/simple.txt
            output/simple.m3u
            output/others.txt
            output/sports.html
            output/custom.txt
            output/custom.m3u
            ${{ env.HISTORY_DIR }}/*.zip
            ${{ env.TARGET_DIR }}/â™ªä¼˜è´¨å¤®è§†.txt
            ${{ env.TARGET_DIR }}/â™ªä¼˜è´¨å«è§†.txt
